"use strict";function _defineProperty(e,r,s){return r in e?Object.defineProperty(e,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[r]=s,e}function init(){var e=global.appConfig.isDev,r=require("../config/config.js"),s=r.JSON_PARSE_ERROR,t=r.ES6_ERROR,i=r.JSON_FILE_ERROR,n=r.JSON_ENTRANCE_ERROR,p=r.JSON_CONTENT_ERROR,o=require("./trans/transManager.js"),c=require("./trace/index.js"),a=require("./utils/tools.js"),l=(require("async"),require("fs")),u=require("path"),g=require("url"),f=(require("querystring"),require("./utils/vendorManager.js")),d=(require("glob"),require("./utils/projectManager.js")),h=require("../config/appserviceConfig.js"),j=require("../stores/projectStores.js"),v=require("../stores/windowStores.js"),w=require("../actions/windowActions.js"),m=require("../stores/configStores.js"),_=require("./utils/parseErr.js"),q=require("../utils/file.js"),y=require("../config/weappConfig.js"),E=y.default_scene,S=(require("../config/compileTypeConfig.js"),require("./tpl/errorTpl.js"),require("./tpl/appserviceErrorTpl.js"),u.join(__dirname,"appservice/asdebug.js")),C=l.readFileSync(S,"utf8"),R=(a.noBrowser.join(","),function(e){setTimeout(function(){var r=e.type,t=void 0;r===s?t=_.parseJsonParseErr(e):r===i?t=_.parseJsonFileErr(e):r===n?t=_.parseJsonEntranceErr(e):r===p&&(t=_.parseJsonContentErr(e)),w.showWeappError(e.type,t)},200)});_exports.getWidget=function(r,s){var i=a.getProject(r),n=g.parse(r),p=n.pathname,o=i.hash,c=/webnode\.js$/.test(p),l=/asdebug\.js$/.test(p),v=/widget$/.test(p),m=/search$/.test(p),q=/widget-sdk\.js$/.test(p),y=/widget-engine\.js$/.test(p),E=/WAWidget\.js$/.test(p),S=/reporter-sdk\.js/.test(p),x=/\.js$/.test(p),P=/favicon\.ico$/.test(p);if(P)s(null,{},"");else if(E)s(null,{},f.getFile("WAWidget.js",i.libVersion));else if(q)s(null,{},f.getFile("widget-sdk.js"));else if(y)s(null,{},f.getFile("widget-engine.js"));else if(S)s(null,{},f.getFile("reporter-sdk.js"));else if(c)s(null,{},f.getFile("webnode.js"));else if(l)s(null,{},C);else if(m){var O=void 0;try{O=d.getAppConfigJSONSync(i)}catch(e){return s(200,{},""),void R(e)}var F=j.getProjectConfig(i);O.projectConfig=F,O.appserviceConfig=h;var $=require("./tpl/widgetServiceTpl.js"),N="http://"+o+".widgetservice.open.weixin.qq.com/",b=[],J=[];d.getAllJSFileList(i,function(r,t){if(O.widgets){var i="",n="";O.widgets.forEach(function(e){i||"search"===e.type&&(i=u.normalize(e.path||""))}),i||b.push('<script>\n              console.group("'+new Date+" 搜索页编译错误\")\n              console.error(` app.json 中 widgets 中为找到 type='search' 的动态页配置`)\n              console.groupEnd()\n            </script>"),n=u.join(i,"widget");for(var p=!1,o=0,c=t.length;o<c;o++){var a=t[o];a=u.normalize(a),0==u.dirname(a).indexOf(i)&&(a.replace(/\.js$/,"")==n?(p=!0,b.push('<script src="'+N+a+'"></script>')):J.push('<script src="'+N+a+'"></script>'))}p||b.push('<script>\n              console.group("'+new Date+' 搜索页编译错误")\n              console.error(`未找到 '+n+".js `)\n              console.groupEnd()\n            </script>")}else b.push('<script>\n            console.group("'+new Date+' 搜索页编译错误")\n            console.error(` app.json 中 widgets 字段为空`)\n            console.groupEnd()\n          </script>');b=J.concat(b),e?(b.unshift('<script src="'+N+'widget-engine.js"></script>'),b.unshift('<script src="'+N+'widget-sdk.js"></script>'),b.unshift('<script src="'+N+'reporter-sdk.js"></script>'),b.unshift('<script src="'+N+'webnode.js"></script>')):b.unshift('<script src="'+N+'WAWidget.js"></script>'),b.unshift('<script src="'+N+'asdebug.js"></script>'),O.platform="devtools",b.unshift("<script>var __wxConfig = "+JSON.stringify(O)+"</script>\n"),$=$.replace("<script></script>",b.join("")),s(null,{},$)})}else if(v){var k=void 0;try{k=d.getAppConfigJSONSync(i)}catch(e){return s(200,{},""),void R(e)}var T=j.getProjectConfig(i);k.projectConfig=T,k.appserviceConfig=h;var A=require("./tpl/widgetServiceTpl.js"),W="http://"+o+".widgetservice.open.weixin.qq.com/",I=[],D=[];d.getAllJSFileList(i,function(r,t){if(k.widgets){var i="",n="";k.widgets.forEach(function(e){i||"conversation"===e.type&&(i=u.normalize(e.path||""))}),i||I.push('<script>\n              console.group("'+new Date+" 搜索页编译错误\")\n              console.error(` app.json 中 widgets 中为找到 type='conversation' 的动态页配置`)\n              console.groupEnd()\n            </script>"),n=u.join(i,"widget");for(var p=!1,o=0,c=t.length;o<c;o++){var a=t[o];a=u.normalize(a),0==u.dirname(a).indexOf(i)&&(a.replace(/\.js$/,"")==n?(p=!0,I.push('<script src="'+W+a+'"></script>')):D.push('<script src="'+W+a+'"></script>'))}p||I.push('<script>\n              console.group("'+new Date+' 动态页编译错误")\n              console.error(`未找到 '+n+".js `)\n              console.groupEnd()\n            </script>")}else I.push('<script>\n            console.group("'+new Date+' 动态页编译错误")\n            console.error(` app.json 中 widgets 字段为空`)\n            console.groupEnd()\n          </script>');I=D.concat(I),e?(I.unshift('<script src="'+W+'widget-engine.js"></script>'),I.unshift('<script src="'+W+'widget-sdk.js"></script>'),I.unshift('<script src="'+W+'reporter-sdk.js"></script>'),I.unshift('<script src="'+W+'webnode.js"></script>')):I.unshift('<script src="'+W+'WAWidget.js"></script>'),I.unshift('<script src="'+W+'asdebug.js"></script>'),k.platform="devtools",I.unshift("<script>var __wxConfig = "+JSON.stringify(k)+"</script>\n"),A=A.replace("<script></script>",I.join("")),s(null,{},A)})}else if(x){var L=r.replace("http://"+o+".widgetservice.open.weixin.qq.com/",""),z=L.replace(/\.js$/,""),B=void 0;try{B=d.getAppConfigJSONSync(i)}catch(e){return s(200,{},""),void R(e)}var M="",U="search"==i.compileType?"search":"conversation";B.widgets.forEach(function(e){M||e.type==U&&(M=e.path)});var K=u.join(M,"widget");d.getScripts({project:i,fileName:L,needRequire:u.normalize(z)===K},function(e,r){if(e)if(r){var n={file:e.sourceFileName,msg:e.msg};s(null,_defineProperty({},t,encodeURIComponent(JSON.stringify(n))),r)}else e.project=i,w.showWeappError(e.type,_.parseJsFileErr(e)),s(200,{},"");else s(null,{"Content-Type":"text/javascript; charset=UTF-8"},r)})}},_exports.getAppservice=function(r,s){var i=a.getProject(r),n=g.parse(r),p=n.pathname,o=/appservice$/.test(p),c=/appservice-sdk\.js$/.test(p),q=/asdebug\.js$/.test(p),y=/ascheck\.js$/.test(p),S=/webnode\.js$/.test(p),x=/reporter-sdk\.js/.test(p),P=/app_service_engine\.js/.test(p),O=(/\.js$/.test(p),/\.js\.map$/.test(p)),F=/WAService\.js/.test(p),$=/favicon\.ico$/.test(p);if($)s(200,{},"");else if(F)s(null,{},f.getFile("WAService.js",i.libVersion));else if(x)s(null,{},f.getFile("reporter-sdk.js"));else if(P)s(null,{},f.getFile("app_service_engine.js"));else if(c)s(null,{},f.getFile("appservice-sdk.js"));else if(q)s(null,{},C);else if(y)s(null,{},asCheck);else if(S)s(null,{},f.getFile("webnode.js"));else if(O){var N=u.join(i.projectpath,p);l.readFile(N,function(e,r){return e?void s(404,{},"do not find "+N):void s(200,{},r)})}else{var b=(i.appname.toLowerCase(),i.appid.toLowerCase(),i.hash),J=void 0;try{J=d.getAppConfigJSONSync(i)}catch(e){return s(200,{},""),void R(e)}var k=j.getProjectConfig(i);J.projectConfig=k,J.appserviceConfig=h;var T=J.pages||[];if(o){var A=require("./tpl/appserviceTpl.js"),W="http://"+b+".appservice.open.weixin.qq.com/",I=[],D=[],L=[],z=J.widget||"";d.getAllJSFileList(i,function(r,t){for(var n={},p=0,o=T.length;p<o;p++){var c=T[p]+".js";z&&(c=u.normalize(c),0==u.dirname(c).indexOf(z))||(n[c]=!0,I.push("<script>__wxRoute = '"+T[p]+"';__wxRouteBegin = true</script>"),I.push('<script src="'+W+c+'"></script>'),I.push('<script>\n              if(__wxRouteBegin) {\n                console.group("'+new Date+' page 编译错误")\n                console.error(` '+T[p]+" 出现脚本错误或者未正确调用 Page()`)\n                console.groupEnd()\n              }\n              </script>"))}for(var a=0,l=t.length;a<l;a++){var g=t[a];if(!n[g]){if("app.js"===g){L.push('<script src="'+W+g+'"></script>');continue}if(z&&(g=u.normalize(g),0==u.dirname(g).indexOf(z)))continue;D.push('<script src="'+W+g+'"></script>')}}I=D.concat(L).concat(I),e?(I.unshift('<script src="'+W+'app_service_engine.js"></script>'),I.unshift("\n"),I.unshift('<script src="'+W+'appservice-sdk.js"></script>'),I.unshift("\n"),I.unshift('<script src="'+W+'reporter-sdk.js"></script>'),I.unshift("\n"),I.unshift('<script src="'+W+'webnode.js"></script>'),I.unshift("\n")):I.unshift('<script src="'+W+'WAService.js"></script>'),I.unshift('<script src="'+W+'asdebug.js"></script>'),J.appname=i.appname,J.app_nickname=i.app_nickname||i.appname,J.appid=i.appid,J.apphash=i.hash,J.isTourist=i.isTourist,J.platform="devtools",i.isTourist&&(J.userInfo=v.getUserInfo()),J.urlCheck=i.urlCheck;var f,d,h=J.entryPagePath.replace(/\.html$/,""),j={},w=E;if(i.initPath.enable){h=i.initPath.page||h;var _=(i.initPath.query||"").split("&");if(_.forEach(function(e){var r=e.split("=");r[0]&&(j[r[0]]=r[1])}),w=i.initPath.scene||E,w==m.getMiniProgramScene()||w==m.getMiniProgramBackScene()){f={},i.initPath.appid&&(f.appId=i.initPath.appid);var q={};if(i.initPath.referData){try{q=JSON.parse(i.initPath.referData)}catch(e){I.push('<script>\n                    if(__wxRouteBegin) {\n                      console.group("'+new Date+' referrerInfo.data 编译错误")\n                      console.error(` 请确认编译条件中的启动数据设置是否正确`)\n                      console.groupEnd()\n                    }\n                    </script>'),q={}}f.extraData=q}}var y=i.initPath.groupInfo;y&&(d={},d.shareKey=y.shareKey||"",d.shareName=y.shareName||"")}J.appLaunchInfo={referrerInfo:f,shareInfo:d,path:h,scene:parseInt(w),query:j},I.unshift("<script>var __wxConfig = "+JSON.stringify(J)+"</script>"),A=A.replace("<script></script>",I.join("")),s(null,{},A)})}else{var B=r.replace("http://"+b+".appservice.open.weixin.qq.com/","");d.getScripts({project:i,fileName:B,needRequire:"app.js"===B||T.indexOf(B.replace(/\.js/,""))!==-1},function(e,r){e?r?(w.showWeappError(t,{file:e.sourceFileName,msg:e.msg}),s(200,{},"")):(e.project=i,w.showWeappError(e.type,_.parseJsFileErr(e)),s(200,{},"")):s(null,{"Content-Type":"text/javascript; charset=UTF-8"},r)})}}},_exports.getLocalIdResponse=function(e,r){if(q.isAppTmpPath(e)){var s=q.getRealPath(e);l.readFile(s,function(e,s){e?r(404,{"Weapp-Error":encodeURIComponent(e)},e.toString()):r(null,{},s)})}else r(404,{},"do not find "+e)},_exports.getResponse=function(e,r){var s=g.parse(e),t=s.pathname,i=/favicon\.ico$/.test(t);i?r(null,{},""):o.getResponse(e,r)},_exports.getWidgetPage=function(e,r){var s=a.getProject(e),t=g.parse(e),i=t.pathname,n=(s.hash,/widgetPage\.html$/.test(i)),p=/favicon\.ico$/.test(i);if(p)r(null,{},"");else if(n){var c=require("./tpl/widgetPageTpl.js");r(null,{},c)}else o.getWidgetResource(e,r)},_exports.getTraceRoute=function(e,r){c.route(e,r)}}var _exports={};init(),module.exports=_exports;