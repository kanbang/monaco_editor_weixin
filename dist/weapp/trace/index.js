"use strict";function init(){var e,n,t=require("../../common/log/log"),i=(require("stream"),require("url"),require("querystring")),r=require("./trace-data"),o=require("../../config/dirConfig"),a=require("fs"),u=require("path"),c=o.WeappTraceFiles,l="/tencent/MicroMsg/appbrand/trace/",f=void 0,s=void 0,d=void 0,h=function(n){e.listDevices().then(function(e){n(null,e)}).catch(function(e){n(e)})},m=function(i){return new Promise(function(r,o){e.shell(i,"echo $EXTERNAL_STORAGE").then(n.util.readAll).then(function(e){var n=e.toString("utf-8").replace(/\r?\n|\r/g,"");if(!(n.trim().length>0)){var i="trace.js could not found SDCard path.";throw t.info(i),new Error(i)}d=n,r(d)}).catch(function(e){o(e)})})},v=function(e){var n=void 0;return e.split(/\r?\n/).forEach(function(e){e.toLowerCase().indexOf("memtotal")>=0&&(n=parseInt(e.split(":")[1]))}),n},g=function(i){return new Promise(function(r,o){e.shell(i,"cat /proc/meminfo").then(n.util.readAll).then(function(e){var n=e.toString("utf-8");if(s=v(n),null==s){var i="trace.js could not found totalmem.";throw t.info(i),new Error(i)}r()}).catch(function(e){o(e)})})},p=function(){var e=u.join(c,f);try{a.mkdirSync(e)}catch(e){if("EEXIST"!==e.code)throw e}},S=function(e,n){m(e).then(function(){return g(e)}).then(function(){f=e,p(),n(null,{deviceId:f,SDCardPath:d,totalMem:s})}).catch(function(e){n(e)})},w=function(e,n){e=e+"_"+Date.now();var t=JSON.stringify(n.result()),i=u.join(c,f,e);a.writeFileSync(i,t,"utf8")},q=function(t){var i=t.length;return new Promise(function(o,a){return 0===t.length?void o():void t.forEach(function(t){var u=d+l+t.name;e.pull(f,u).then(n.util.readAll).then(function(n){var i=n.toString("utf-8"),o=new r;return s&&(o.totalMem=s/1024),o.parse(i),w(t.name,o),e.shell(f,"rm "+u)}).then(function(){i-=1,0===i&&o()}).catch(function(e){a(e)})})})},y=function(n){e.readdir(f,d+l).then(function(e){return q(e)}).then(function(){t.info("start to get localTraceFiles");var e=u.join(c,f),i=a.readdirSync(e);n(null,i.filter(function(e){return 4===e.split("_").length}))}).catch(function(e){n(e)})},x=function(e,n){var t=u.join(c,f,e);try{var i=a.readFileSync(t,"utf8");n(null,JSON.parse(i))}catch(e){n({message:e.message})}},E=function(e,n){var t=u.join(c,f,e);try{a.unlinkSync(t);n(null,{message:"delete ok"})}catch(e){n({message:e.message})}},O=function(t,r){n||(n=require("adbkit")),e||(e=n.createClient());var o=i.parse(t.query);if(t.pathname.indexOf("listDevices")>0)h(r);else if(t.pathname.indexOf("chooseDevice")>0){var a=o.deviceId;if(null==a)return void r({message:"deviceId is null."});S(a,r)}else if(t.pathname.indexOf("listFiles")>0){if(null==f)return void r({message:"must choose device first."});y(r)}else if(t.pathname.indexOf("getTraceFile")>0){if(null==f)return void r({message:"must choose device first."});var u=o.fileName;if(null==u)return void r({message:"fileName is null."});x(u,r)}else if(t.pathname.indexOf("deleteTraceFile")>0){if(null==f)return void r({message:"must choose device first."});var c=o.fileName;if(null==c)return void r({message:"fileName is null."});E(c,r)}};_exports={route:O}}var _exports;init(),module.exports=_exports;