"use strict";function init(){var e=require("fs"),o=require("./pack.js"),r=require("./build.js"),i=require("path"),t=require("../../common/request/request.js"),n=require("../../config/dirConfig.js"),p=require("../../stores/projectStores.js"),a=require("../../weapp/utils/projectManager.js"),u=require("../../config/urlConfig.js"),s=require("rmdir"),d=require("zlib"),c=require("../../common/log/log.js");_exports={};var l=n.Weappdest;_exports.uploadForTest=function(n,f,g){var v=p.getProjectConfig(n),m=void 0;try{m=v.Setting.MaxCodeSize}catch(e){m=1}var q=1024*m,j=!f.isBuildForUpload;r(n,{noCompile:!0},function(r,p){if(r)return void g(r.toString());var v=i.join(l,+new Date+".wx");o(p,v,function(o,r){s(p,function(e,o,r){});var i=e.lstatSync(v),l=parseInt(i.size/1024);if(l>q)return e.unlink(v,function(){}),void g("代码包大小为 "+l+" kb，超出限制 "+(l-q)+" kb，请删除文件后重试");var m=void 0;if(j){m=global.appConfig.isBeta?u.testSourceNewFeatureURL+"?appid="+n.appid+"&gzip=1":u.testSourceURL+"?appid="+n.appid+"&gzip=1";var x=f.page,S=f.query,h=f.searchQuery,C=f.boxQI;if(S&&!x)try{var _=a.getAppJSONSync(n);x=_.pages[0]}catch(e){}if(x){var y=encodeURIComponent(x+"?"+S);m=m+"&path="+y}if((h||C)&&(m=m+"&search_query="+encodeURIComponent(h),C)){var U={box_qi:C};m=m+"&search_extInfo="+encodeURIComponent(JSON.stringify(U))}var I=a.getExtAppId(n)||"",R="&ext_appid="+I+"&platform="+(n.platform?1:0);m=""+m+R}else{var b=encodeURIComponent(f.desc),z=encodeURIComponent(f.version),k=encodeURIComponent(f.uuid);m=u.commitSourceURL+"?appid="+n.appid+"&user-version="+z+"&user-desc="+b+"&uuid="+k+"&gzip=1"}var F=e.readFileSync(r);c.info("upload.js upload file "+r+" length "+F.length);var w=d.gzipSync(F);c.info("upload.js upload file "+r+" after gzip length "+w.length),t({url:m,method:"post",body:w,needToken:1},function(o,r,i){g(o,r,i,{MAX_APP_LENGTH:q}),e.unlink(v,function(){})})})})},_exports.upload=function(e,o,r){o.isBuildForUpload=!0,_exports.uploadForTest(e,o,r)}}var _exports;init(),module.exports=_exports;