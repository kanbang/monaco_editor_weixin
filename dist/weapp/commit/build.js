"use strict";function init(){function r(r){return 0===Buffer.compare(new Buffer(r.toString(),"utf8"),r)}var e="darwin"===process.platform,i=global.appConfig.isDev,o=require("fs"),n=require("path"),t=require("../utils/tools.js"),s=require("glob"),c=require("async"),a=require("../../config/dirConfig.js"),u=a.WeappVendor,l=require("mkdir-p"),f=require("./initAppConfig.js"),p=require("./initAppServiceJs.js"),d=require("./initExtConfig.js"),v=(require("child_process").spawn,require("../../common/log/log.js")),j=require("babel-core"),g=require("autoprefixer"),m=require("postcss"),b=require("uglify-js"),w=i?n.join(__dirname,"../vendor/"):u,x=(e?n.join(w,"wcc"):n.join(w,"wcc.exe"),["iOS >= 8","Chrome >= 37"]),q=a.Weappdest,h={".js":!0,".json":!0,".wxml":!0,".wxss":!0,".wxs":!0},y=t.whiteFileExtName;_exports=function(e,i,t){var a=(e.projectpath,e.es6),u=e.minified,w=e.postcss,S=!!e.ext_appid,_=n.join(q,""+ +new Date);l.sync(_);var E={};E.appconfig=function(r){f(e,i,function(e,i){r(e,i)})},E.extconfig=function(r){d(e,i,function(e,i){r(e,i)})},E.appservicejs=function(r){p(e,i,function(e,i){r(e,i)})},c.parallel(E,function(i,c){return i?void t(i.toString()):void s("./**",{nodir:!0,cwd:e.projectpath,ignore:["./node_modules/**/*"]},function(i,s){if(i)v.error("build.js error while glob files "+i.toString()),t(i.toString(),_);else{for(var c=0;c<s.length;c++){var f=s[c],p=n.extname(f);if(y[p])if(e.platform&&!S&&"./ext.json"===f)v.info("build.js find ext.json but project.ext_appid is false");else{var d=n.join(_,f),q=n.dirname(d);l.sync(q);var E=void 0;try{E=o.readFileSync(n.join(e.projectpath,f))}catch(r){return void t(r.toString(),_)}if(h[p]&&!r(E))return void t(f+" - 不是 UTF8 编码，请检查后重试");if(".js"===p){var F=E.toString();if(a||u){var C=F;if(a){try{var A=j.transform(F,{presets:["es2015"],babelrc:!1});C=A.code}catch(r){return void t(f+" - "+r)}if(u){var B=void 0;try{B=b.minify("(function(){\n "+C+" \n})()",{fromString:!0}),C=B.code}catch(r){return void t(f+" "+r.line+" - "+r.message)}C=B.code}}else try{var D=j.transform(F,{presets:["babili"],babelrc:!1});C=D.code}catch(r){return void t(f+" - "+r)}o.writeFileSync(d,C)}else o.writeFileSync(d,F)}else if(w&&".wxss"===p){var W=E.toString();try{var k=m([g({browsers:x,remove:!1})]).process(W).css;o.writeFileSync(d,k,"utf8")}catch(r){var J=void 0;return r.parseError?(v.error("build.js build css error "+f+" "+r.parseError.line+":"+r.parseError.column+" - "+r.message),J=f+" "+r.parseError.line+":"+r.parseError.column+" - "+r.message):(v.error("build.js build css error$ {file}  "+r),J=f+" parse wxss error "+r),void t(J)}}else o.writeFileSync(d,E)}else v.info("build.js find file not in whiteList "+f)}t(null,_)}})})}}var _exports;init(),module.exports=_exports;