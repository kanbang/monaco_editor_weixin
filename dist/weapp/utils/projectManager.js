"use strict";function init(){function e(){F.info("projectManager.js cleanProjects");for(var e in I)I[e].watcher&&I[e].watcher.close();I={}}function t(a){var n=a.hash;if(!I[n]){M.project=a,Object.keys(I).length>C&&e(),F.info("manager.js initProject projectid "+a.projectid);var i={cache:{},wxmlFileList:[],jsFileList:[]};I[n]=i,i.watcher=P.watch(a.projectpath,{ignored:[/node_modules/],ignoreInitial:!0,ignorePermissionErrors:!0,followSymlinks:!0,interval:1e3,binaryInterval:1e3}).on("all",function(e,t,n){var i=O.extname(t);(/dir/i.test(e)||N.whiteFileExtName[i])&&(t=O.relative(a.projectpath,t),r(a,e,t,n))}),i.watcher.on("error",function(r){r&&!k&&(F.error("projectManager.js obj.watcher error "+r.toString()),k=!0,e(),t(a))}),A.setProjectExtAppid(n,d(a))}}function r(e,t,r,i){var o=e.hash,s=I[o].cache;r=r.replace(/\\/g,"/"),"app.json"!==r&&"ext.json"!==r||(I[o].cache={},"ext.json"===r&&A.setProjectExtAppid(o,d(e))),r&&s[r]&&(delete s[r],delete s["app-config.json"]);var c=O.extname(r);".wxml"===c?(clearTimeout(w),I[o].wxmlFileList=[],w=setTimeout(function(){a(e)},20)):".js"===c&&(clearTimeout(y),I[o].jsFileList=[],y=setTimeout(function(){n(e)},20)),M.fileChange(e,t,r,i)}function a(e,t){try{var r=R.sync("./**/*.wxml",{nodir:!0,cwd:e.projectpath,ignore:["node_modules/**/*"],nosort:!0,strict:!1,silent:!0}),a=e.hash;I[a].wxmlFileList=r,t&&t(null,r)}catch(e){F.error("projectManager.js findAllWXMLFiles "+e.toString()),t&&t(e,[])}}function n(e,t){try{var r=e.projectpath,a=R.sync("**/*.js",{nodir:!0,cwd:r,ignore:["node_modules/**/*"],nosort:!0,strict:!1,silent:!0}),n=e.hash;I[n].jsFileList=a,t&&t(null,a)}catch(e){F.error("projectManager.js findAllJSFiles "+e.toString()),t&&t(e,[])}}function i(e,t){var r=e.project,a=decodeURIComponent(e.fileName),n=b(r);if(n[a])return void process.nextTick(function(){t(n[a].error,n[a].data)});var i=r.es6,o=e.needRequire,s=r.projectpath,c=O.join(s,a);S.readFile(c,"utf8",function(e,r){if(e)return void t({e:e,type:L.PAGEJS_FILE_ERROR,file:a});if(i){var s=O.basename(a);try{var c=_.transform(r,{presets:["es2015"],sourceMaps:"inline",sourceFileName:s,babelrc:!1});r=c.code.replace("sourceMappingURL=data:application/json;","sourceMappingURL=data:application/json;charset=utf-8;")}catch(e){var l="";return e.loc&&(l=B(r,e.loc.line,e.loc.column>0?e.loc.column:1)),void t({msg:e.toString()+"\n"+l,sourceFileName:s},r)}}r='define("'+a+'", function(require, module, exports, '+J+"){ "+r+"\n});",o&&(r+='require("'+a+'")'),n[a]={error:null,data:r},t(null,r)})}function o(e,t,r){var a=b(e);if(a[t])return void process.nextTick(function(){r(a[t].error,a[t].data)});var n=e.projectpath,i=O.join(n,t);S.readFile(i,function(e,n){e||(a[t]={error:e,data:n}),r(e,n)})}function s(e,t){var r=(e.hash,v(e)),n=r.wxmlFileList;n.length?process.nextTick(function(){t(null,n)}):a(e,t)}function c(e,t){var r=v(e),a=r.jsFileList;a.length?process.nextTick(function(){t(null,a)}):n(e,t)}function l(e,t){var r=x.parse(t),a=r.pathname.replace(/^\//,""),n=O.extname(a),i=n?a.replace(n,".json"):a+".json",o=b(e);if(o[i])return o[i];var s=e.projectpath,c=h(e),l=u(e)||{},p=O.join(s,i),f=S.existsSync(p),g=l&&l.extEnable&&l.extPages&&l.extPages[t],j={};if(f){var d=S.readFileSync(p,"utf8");try{j=JSON.parse(d)}catch(e){throw{e:e,data:d,type:L.JSON_PARSE_ERROR,file:i}}}return o[i]=Object.assign({},c.window,j,g?l.extPages[t]:{}),o[i]}function p(e){var t=b(e),r="app-config.json",a=t[r];if(a)return a;a={};var n=h(e)||{};a.pages=n.pages||[],a.entryPagePath=n.pages[0]+".html",a.debug=n.debug||!1,a.networkTimeout=Object.assign({request:6e4,uploadFile:6e4,connectSocket:6e4,downloadFile:6e4},n.networkTimeout),a.widgets=n.widgets,a.global={window:n.window||{}},a.customClose=new Boolean(n.customClose),a.ext=n.ext||{},a.extAppid=n.extAppid||"",a.page={};for(var i=n.pages,o=0;o<i.length;o++){var s=i[o],c={};try{c=l(e,s)}catch(e){throw{e:e,type:L.JSON_FILE_ERROR,file:s+".json"}}a.page[s+".html"]={window:c}}if("[object Object]"==Object.prototype.toString.call(n.tabBar)){for(var p=Object.assign({},n.tabBar),u=[].concat(p.list||[]),f=[],o=0;o<u.length;o++){var g=Object.assign({},u[o]);g.pagePath+=".html",f.push(g)}p.list=f,a.tabBar=p}return t[r]=a,a}function u(e){var t=b(e),r=e.projectpath,a="ext.json",n=O.join(r,a),i=S.existsSync(n);if(i){var o=t[a];if(o)return o;var s=void 0;try{s=S.readFileSync(n,"utf8")}catch(e){throw{e:e,type:L.JSON_FILE_ERROR,file:a}}try{o=JSON.parse(s)}catch(e){throw{e:e,type:L.JSON_PARSE_ERROR,file:a,data:s}}return t[a]=o,o}return{}}function h(e){var t="app.json",r=b(e),a=r[t];if(a)return a;var n=e.projectpath,i=O.join(n,"app.json"),o=void 0;try{o=S.readFileSync(i,"utf8")}catch(e){throw{e:e,type:L.JSON_FILE_ERROR,file:"app.json"}}try{a=JSON.parse(o)}catch(e){throw{e:e,type:L.JSON_PARSE_ERROR,file:"app.json",data:o}}if(e.platform)try{var s=u(e);if(s&&s.extEnable)for(var c in s)"extPages"!==c&&("[object object]"==Object.prototype.toString.call(s[c]).toLowerCase()?a[c]=Object.assign({},a[c]||{},s[c]):a[c]=s[c])}catch(e){throw{e:e,type:L.JSON_PARSE_ERROR,file:"ext.json",data:e.data}}var l=a.pages;if(!l||0===l.length)throw{type:L.JSON_ENTRANCE_ERROR,file:"app.json",data:o};var p=a.tabBar,h=[];if(p)if("[object Array]"!=Object.prototype.toString.call(p.list))h.push("tabBar.list 应为数组");else if(!p.list||p.list.length<2)h.push("tabBar.list 需至少包含两个项目");else if(p.list.length>5)h.push("tabBar.list 不能超过 5 个配置项");else for(var f=0;f<p.list.length;f++){var g=p.list[f];if("[object Object]"==Object.prototype.toString.call(g)){var j=g.pagePath;if(j)if("[object String]"==Object.prototype.toString.call(j)){j.split("?").length>=2?h.push("tabBar.list["+f+"].pagePath 不应该包含'?'"):j.split(".").length>=2&&h.push("tabBar.list["+f+"].pagePath 不应该包含'.'");var d=[];g.iconPath&&d.push({name:"iconPath",path:O.join(e.projectpath,g.iconPath)}),g.selectedIconPath&&d.push({name:"selectedIconPath",path:O.join(e.projectpath,g.selectedIconPath)}),d.forEach(function(e){if(!S.existsSync(e.path))return h.push("tabBar.list["+f+"]."+e.name+" 文件不存在");var t=S.statSync(e.path);if(t.isDirectory())return h.push("tabBar.list["+f+"]."+e.name+" 需为文件");if(t.size>q)return h.push("tabBar.list["+f+"]."+e.name+" 大小超过 "+q/1024+"kb");var r=O.extname(e.path);return T.indexOf(r)<0?h.push("tabBar.list["+f+"]."+e.name+" 文件格式错误，仅支持"+T.join("、")+"格式"):void 0})}else h.push("tabBar.list["+f+"].pagePath 需为 String");else h.push("tabBar.list["+f+"].pagePath 为空，请检查")}else h.push("tabBar.list["+f+"] 需为 Object")}if(a.widgets&&("[object Array]"!==Object.prototype.toString.call(a.widgets)?h.push("widgets 需为数组"):a.widgets.forEach(function(t,r){if("search"!=t.type&&"conversation"!=t.type&&h.push("widgets["+r+"].type 需为 'search' 或 'conversation'"),"string"!=typeof t.path)return h.push("widgets["+r+"].path 为空或不是字符串，请检查");var a=O.join(e.projectpath,t.path,"widget.js");S.existsSync(a)||h.push("widgets["+r+"].path 指定的路径下未找到 widget.js 请检查")})),h.length>0)throw{type:L.JSON_CONTENT_ERROR,file:"app.json",data:h.join("\n")};return a.window||(a.window={}),r[t]=a,a}function f(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=N.getBaseURL(e);if(t.justHost)return r;var a=h(e)||{},n=a.pages||[],i=n[0]+".html",o=e.initPath;if(o&&o.enable){var s=o.page||n[0];i=s+".html?"+o.query}return x.resolve(r,i)}function g(e,t){var r=h(e),a=r.pages||[];t=t.replace(/\\/g,"/");var n=a.findIndex(function(e){return e===t});return n!==-1}function j(e,t){for(var r=O.resolve(t),a=h(e),n=a.tabBar||{},i=n.list||[],o=0;o<i.length;o++)if(r===O.resolve(i[o].pagePath))return!0;return!1}function d(e){try{var t=u(e);if(t&&t.extEnable&&t.extAppid)return t.extAppid}catch(e){}return""}function v(e){var r=e.hash;return I[r]||t(e),I[r]}function b(e){return v(e).cache}function m(e){var r=e.hash,a=I[r];a?(a.cache={},a.wxmlFileList=[],a.jsFileList=[]):t(e)}var w,y,S=require("fs"),O=require("path"),x=require("url"),E=require("events").EventEmitter,R=require("glob"),P=require("chokidar"),_=require("babel-core"),F=require("../../common/log/log.js"),N=require("./tools.js"),A=require("../../stores/projectStores.js"),L=require("../../config/config.js"),B=require("babel-code-frame"),J=N.noBrowser.join(","),q=40960,C=1,T=[".png",".jpg",".jpeg"],I={},k=!1;A.on("PROJECT_STORES_CONFIG_CHANGE",function(e){F.info("projectManager.js project config change"),m(e)}),A.on("ON_COMPILE_CHANGE",function(){var e=A.getCurrentProject();m(e)});var M=Object.assign({},E.prototype,{fileChange:function(e,t,r,a){this.emit("FILE_CHANGE",e,t,r,a)},stopWatch:function(){e()},restartWatch:function(){t(this.project)}});_exports={manager:M,getFile:o,getAllWXMLFileList:s,getAllJSFileList:c,getScripts:i,getAppJSONSync:h,getExtJSONSync:u,getAppEntranceSync:f,getPageJSONSync:l,getAppConfigJSONSync:p,isProjectPage:g,getExtAppId:d,isTabBar:j}}var _exports;init(),module.exports=_exports;