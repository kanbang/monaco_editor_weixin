"use strict";function init(){var e=global.appConfig.isDev,n=require("path"),r=require("fs"),i=require("events").EventEmitter,o=require("request"),t=require("../../stores/projectStores.js"),c=require("../../config/dirConfig.js"),a="darwin"===process.platform,f=c.WeappVendor,s=n.join(f,"config.json"),u=require("../../common/log/log.js"),d=n.join(__dirname,"../onlinevendor/"),l=n.join(d,"config.json"),v=JSON.parse(r.readFileSync(l,"utf8")),g=n.join(__dirname,"../vendor/"),y=(n.join(d,"vendorConfig.json"),a?{wcc:!0,wcsc:!0}:{"wcc.exe":!0,"wcsc.exe":!0});y["hls.js"]=!1,y.region=!1;var S=void 0,j={},h={},m=void 0,V=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"error";m||(m=require("../../actions/windowActions.js")),m.showTipsMsg({type:n,msg:e})},p=function(e){u.error(__filename+" "+e)},C=new i,F=function(){try{if(S=JSON.parse(r.readFileSync(s,"utf8")),S.configVersion>=v.configVersion)return void w()}catch(e){u.error(__filename+" checkVendorConfig catch error "+e)}_(),w()},_=function(){var e=JSON.stringify(v);r.writeFileSync(s,e),S=v;for(var i in y){var o=n.join(f,i),c=r.readFileSync(n.join(d,i));y[i]?r.writeFileSync(o,c,{mode:511}):r.writeFileSync(o,c)}var a=S.currentLibVersion,u=n.join(d,a);if(r.existsSync(u)){var l=r.readdirSync(u),g=n.join(f,a);r.existsSync(g)||r.mkdirSync(g),l.forEach(function(e){r.writeFileSync(n.join(g,e),r.readFileSync(n.join(u,e)))})}t.resetProjectLibVersion(S.currentLibVersion),C.emit("VENDOR_CONFIG_CHANGE",S)},w=function(){for(var e in y){var i=n.join(f,e);j[e]=r.readFileSync(i,"utf8")}},N=function(i,o){var t="";if(e)t=r.readFileSync(n.join(g,i),"utf8");else if(y.hasOwnProperty(i))t=j[i];else if(j[o]&&j[o][i])t=j[o][i];else try{O(o),t=j[o][i]}catch(e){u.error("vendorManager getFile catch error "+e)}return t},O=function(e){if(j[e]={},S.libs[e]){var i=S.libs[e],o=n.join(f,e);try{for(var t in i){var c=n.join(o,t);j[e][t]=r.readFileSync(c,"utf8")}return}catch(e){p("initVendorCache readFile from vendorPath catch error "+e)}o=n.join(d,e);try{var a=n.join(f,e);r.existsSync(a)||r.mkdirSync(a);for(var s in i){var u=r.readFileSync(n.join(o,s),"utf8");r.writeFileSync(n.join(a,s),u),j[e][s]=u}return}catch(e){p("initVendorCache readFile from toolsVendorPath catch error "+e)}for(var l in i)q({url:i[l]||"https://dldir1.qq.com/WechatWebDev/vendor/"+e+"/"+l,fileName:l,version:e});V("正在下载对应版本的基础库，请稍后重新编译")}else _(),V("基础库版本异常，正在重建，请稍后重新编译")},q=function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};h[e.url]&&clearTimeout(h[e.url]);var t=e.fileName,c=e.version;h[e.url]=setTimeout(function(){o({url:e.url,needToken:!1,encoding:null},function(e,o,a){if(e)i("未找到 "+t+" "+e,{fileName:t,version:c});else{var s=a.toString();j[c]||(j[c]={}),j[c][t]=s;var u=n.join(f,c);r.existsSync(u)||r.mkdirSync(u),r.writeFileSync(n.join(u,t),s),i(null,{fileName:t,version:c,fileData:s})}})})},b=function(e){if(j[e]){var n=S.libs[e];if(n){for(var r in n)if(!j[e][r])return!1;return!0}}return!1},x=function(e,n){try{b(e)||O(e),C.emit("VENDOR_CHANGE"),n(null)}catch(e){}},E=function(e){if(e){var n={url:e,needToken:0,encoding:null};u.info(__filename+" begin get new vendorConfig "+e),o(n,function(e,n,i){if(e)p("vendorManager.js updateVendorConfig end error "+e);else try{var o=JSON.parse(i.toString());S.configVersion<o.configVersion?(S=o,r.writeFileSync(s,JSON.stringify(S)),C.emit("VENDOR_CONFIG_CHANGE",S),V("更新基础库配置成功！","success"),u.info(__filename+" updateVendorConfig end get new vendorConfig: "+S)):p("updateVendorConfig end get old vendorConfig")}catch(e){p("updateVendorConfig end catch "+e.toString())}})}},k=function(){return S.currentLibVersion},D=function(){return S};F(),_exports={on:function(e,n){C.on(e,n)},removeListener:function(e,n){C.removeListener(e,n)},checkConfig:function(e){try{var n=e.vendor;n&&(n=JSON.parse(n),n.version&&n.version>S.configVersion&&E(n.url))}catch(e){u.error("vendorManager checkConfig catch error "+e)}},getFile:N,changeVendorVersion:x,updateVendorConfig:E,getVendorConfig:D,getCurrentVendorVersion:k}}var _exports;init(),module.exports=_exports;