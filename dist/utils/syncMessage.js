"use strict";function init(){var e=require("../common/request/request.js"),s=require("../config/urlConfig.js"),r=require("../common/log/log.js"),n=require("../config/messageConfig.js"),t=require("events").EventEmitter,c=require("./notifyManager.js"),a=6e5,o=function(){try{var e=JSON.parse(localStorage.getItem("sync_key"));if(e.hasOwnProperty("sync_id")&&e.hasOwnProperty("sync_seq"))return e}catch(e){}return{sync_id:1,sync_seq:0}},i=function(){try{var e=JSON.parse(localStorage.getItem("batch_sync_key"));if(e.hasOwnProperty("sync_id")&&e.hasOwnProperty("sync_seq"))return e}catch(e){}return{sync_id:2,sync_seq:0}},y=function(e){localStorage.setItem("sync_key",JSON.stringify(e))},u=function(e){localStorage.setItem("batch_sync_key",JSON.stringify(e))},p=function(e){var s=JSON.parse(e.content);if("updateVendorConfig"==s.command){var r=require("../weapp/utils/vendorManager.js"),n=s.url;r.updateVendorConfig(n)}else"exec"==s.command},f=function(e){try{switch(e.type){case n.MsgType.tips:c.handleSyncMessage(e);break;case n.MsgType.cmdTips:c.handleCmdTips(e);break;case n.MsgType.systemMsg:p(e)}}catch(e){r.error("syncMessage.js handleMessage catch error "+e)}},g=function(e){for(var s=[],r=null,t=0,c=e.length;t<c;t++){var a=e[t];if(a.type===n.MsgType.cmdTips)try{var o=JSON.parse(a.content);if(o.tips_type==n.CmdTipsType.visitBBS){r=a;continue}}catch(e){}s.push(a)}return r&&s.push(r),s},d=function(e){if(e&&e.data){var s=JSON.parse(e.data).list;s=g(s);for(var r=0,n=s.length;r<n;r++){var t=s[r];f(t)}}},l=function(){var n=o(),t=i();e({url:s.syncMessage,method:"post",body:JSON.stringify({sync_key:[n,t]}),needToken:1},function(e,s,n){var t="";if(e)t="syncMessage.js sync server return "+e;else try{var c=JSON.parse(n),a=c.baseresponse&&c.baseresponse.errcode;if(0===a)try{var o=c.sync_data[0],i=c.sync_data[1];d(o),d(i),o&&y(o.sync_key),i&&u(i.sync_key)}catch(e){t="syncMessage.js sync catch error "+e}else t="syncMessage.js sync errcode "+a}catch(e){t="syncMessage.js sync catch error "+e}t&&r.error(t)})};_exports={on:function(e,s){t.on(e,s)},removeListener:function(e,s){t.removeListener(e,s)},startSync:function(){l(),setInterval(function(){l()},a)},sync:l}}var _exports;init(),module.exports=_exports;