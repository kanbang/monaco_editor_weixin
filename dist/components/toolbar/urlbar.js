"use strict";function init(){var t,e=require("../../lib/react.js"),o=(require("../../cssStr/cssStr.js"),require("../../actions/webviewActions.js")),s=require("../../stores/windowStores.js"),i=require("../../actions/windowActions.js"),n=require("./urlcomplete.js"),a=e.createClass({displayName:"Urlbar",getInitialState:function(){return{webviewID:0,url:"",autoIndex:0,autocomplete:[],showHistory:!1}},loadUrl:function(t){t=t||this.getCurrentUrl(),t=t.trim();var e=this.state.webviewID;"about:blank"===t?o.setWebviewAction(e,{act:"reLoad"}):(i.setAutoComplete(t),o.getA8keyWebview(e,{url:t,isSync:!0,from:"urlbar"})),this.setState({autocomplete:[]})},getAutoComplete:function(t){var e=t.trim(),o=/^http:\/\//.test(e),i=/^https:\/\//.test(e),n=o||i,a=[],r=s.getAutoComplete();return r.forEach(function(t){e.length>4&&(n?/^https?:\/\//.test(t)||(t=o?"http://"+t:"https://"+t):t=t.replace(/^https?:\/\//,"")),0===t.indexOf(e)&&a.indexOf(t)===-1&&a.push(t)}),a},handleKeyUp:function(t){var e=t.target,o=t.keyCode;this.state.webviewID;if(13===o)e.selectionStart=e.value.length,this.loadUrl();else if(40===o||38===o){var s=this.state.autoIndex,i=this.getCurrentUrl(),n=38===o;if(n)s--,s=s<=0?0:s;else{var a=this.state.autocomplete.length;s++,s=s>=a?a-1:s}i=s>=0?this.state.autocomplete[s]:i,this.setState({autoIndex:s,url:i},function(){setTimeout(function(){e.selectionStart=e.value.length},17)})}else 8===o&&(e.dataset.changeFrom="backspace")},handleChange:function(t){var e=this,o=t.target,s=o.value,i="backspace"===o.dataset.changeFrom,n=this.getAutoComplete(s);this.state.webviewID;if(i)return o.dataset.changeFrom="",void this.setState({url:s,autocomplete:n});var a=n[0]&&!i?n[0]:s;this.setState({url:a,autocomplete:n},function(){var t=a.indexOf(s)+s.length;t!==a.length&&(e.refs.urlinput.selectionStart=t,e.refs.urlinput.selectionEnd=a.length)})},handleBlur:function(){this.toShowHistory||this.setState({showHistory:!1,autocomplete:[]})},handleFocus:function(){var t=this,e=this.getCurrentUrl();this.setState({autocomplete:this.state.showHistory?this.getAutoComplete(""):this.getAutoComplete(e)},function(){t.toShowHistory=!1})},handleOnClick:function(){this.loadUrl()},getCurrentUrl:function(){return this.state.url},autoClick:function(e){clearTimeout(t);var o=e.currentTarget,s=o.dataset,i=s.index,n=this.state.autocomplete[i];this.setState({url:n,autocomplete:[]}),this.loadUrl(n)},_changeWebviewID:function(t){this.setState({webviewID:t})},_changeUrl:function(t){0===t.indexOf("chrome-extension:")&&(t="about:blank"),this.setState({url:t})},_focusAddressbar:function(t){this.refs.urlinput.select(),this.refs.urlinput.focus()},_showHistory:function(){var t=this;this.toShowHistory=!0,this.setState({showHistory:!0},function(){t.refs.urlinput.select(),t.refs.urlinput.focus()})},componentDidMount:function(){s.on("CHANGE_WEBVIEW_URL",this._changeUrl),s.on("FOCUS_ADDRESSBAR",this._focusAddressbar)},componentWillUnmount:function(){s.removeListener("CHANGE_WEBVIEW_URL",this._changeUrl),s.removeListener("FOCUS_ADDRESSBAR",this._focusAddressbar)},render:function(){var t=(this.state.webviewID,this.state.url);return e.createElement("div",{className:"toolbar-location"},e.createElement("input",{className:"toolbar-location-input",type:"text",ref:"urlinput",onKeyDown:this.handleKeyUp,onBlur:this.handleBlur,onFocus:this.handleFocus,value:t,onChange:this.handleChange}),e.createElement("div",{className:"toolbar-location-refresh",onClick:function(){this.loadUrl()}.bind(this)},e.createElement("i",{className:"toolbar-location-refresh-icon"})),e.createElement("div",{className:"toolbar-location-history"},e.createElement("i",{className:"toolbar-location-history-icon",onClick:function(){this._showHistory()}.bind(this)})),e.createElement(n,{autoClick:this.autoClick,autocomplete:this.state.autocomplete,autoIndex:this.state.autoIndex}))}});_exports=a}var _exports;init(),module.exports=_exports;