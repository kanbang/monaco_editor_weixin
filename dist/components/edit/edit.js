"use strict";function init(){function e(e){return e=e.replace(/\\/g,"/"),"/"===e[0]?e:"/"+e}function t(e){return{mtime:+e.mtime,birthtime:+e.birthtime,isDir:e.isDirectory(),size:e.size}}function r(e){try{return o.lstatSync(e)}catch(e){return{isDirectory:function(){return!1}}}}var s,i=require("glob"),o=require("fs"),n=require("path"),a=require("url"),c=(require("rmdir"),require("trash")),p=require("image-size"),h=require("../../lib/react.js"),u=require("../../cssStr/cssStr.js"),d=(require("../../actions/webviewActions.js"),require("../../actions/windowActions.js")),f=require("../../stores/windowStores.js"),E=require("../../actions/projectActions.js"),_=require("../../weapp/utils/tools.js"),m=require("../../weapp/utils/projectManager.js"),l=require("../../stores/projectStores.js"),g=require("../../common/log/log.js"),v=require("child_process"),w=v.spawn,R=(v.spawnSync,v.exec,require("./utils/editTools.js")),S=require("./utils/grep.js"),b=require("./utils/formatCode.js"),j=require("./config/config.js"),N=j.pageJS,I=j.pageJSON,T=j.pageWXML,D=j.pageWXSS,M={".js":N,".wxml":T,".json":I,".wxss":D},O={},A=!1,L=("win32"===process.platform,{".jpg":!0,".png":!0,".jpeg":!0,".icon":!0,".gif":!0,".svg":!0,".cer":!0}),y=function(e){d.showTipsMsg({msg:e,type:"error"})},C=function(e,t,r){"Function"===Object.prototype.toString.call(t).slice(8,-1)&&(r=t),d.showConfirm({content:e,subcontent:t,callback:r})},F=h.createClass({displayName:"Edit",getInitialState:function(){return this.msgQuery=[],{project:this.props.project}},onMessage:function(h){var u=this,d=h.command,g=h.msg,v=h.ext,j=this.state.project;switch(d){case"GET_FILE_LIST":if(A)return;A=!0;var N=g.options,I=N.ignore||["node_modules/**/*","node_modules"];i("**",{cwd:j.projectpath,ignore:I,nosort:!0,strict:!1,silent:!0},function(e,s){A=!1;for(var i={ret:e?e.toString():0,res:{files:e?[]:s,info:{}}},o=0;o<s.length;o++){var a=s[o],c=n.join(j.projectpath,a),p=r(c),h=p.isDirectory();h&&(s[o]=a+"/"),s[o]="/"+s[o],i.res.info[s[o]]=t(p)}s.forEach(function(e){O[e]=!0}),i.res.projectpath=j.projectpath,u.postMessage("webframe","RETURN_RES",i,v)});break;case"GET_FILE_DATA":var T=g.path,D=n.extname(T);if(L[D]){var y="";try{y=decodeURI(a.resolve(_.getBaseURL(j),T))}catch(e){y=a.resolve(_.getBaseURL(j),T)}var C=void 0;try{C=p(n.join(j.projectpath,T))}catch(e){C={width:-1,height:-1}}this.postMessage("webframe","RETURN_RES",{ret:0,res:{data:y,dimensions:C}},v)}else{var F=n.join(j.projectpath,T);o.readFile(F,"utf8",function(e,s){var i=r(F),o=t(i),n={ret:e?e.toString():0,res:{data:e?"":s,info:o}};u.postMessage("webframe","RETURN_RES",n,v)})}break;case"SAVE_FILE_DATA":var W=n.join(j.projectpath,g.path),U=g.data,P=void 0;try{l.emit("FILE_CHANGE_FROM_EDITOR"),o.writeFileSync(W,U,"utf8");var k=o.lstatSync(W),G=+k.mtime;if(O[e(g.path)]=G,P={ret:0,res:{path:g.path,info:t(k)}},"/app.json"===g.path){var q=f.getEditorConfig("autoSave");if(q)clearTimeout(s),s=setTimeout(function(e,t){s=void 0;try{var r=JSON.parse(t),i=r.pages||[];R.initPage(e,i)}catch(e){}}.bind(this,j,U),3e3);else{try{var H=JSON.parse(U),B=H.pages||[];R.initPage(j,B)}catch(e){}s=void 0}}}catch(e){P={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",P,v);break;case"DEL_FILE":var x=g.path,J=void 0;try{l.emit("FILE_CHANGE_FROM_EDITOR"),c(n.join(j.projectpath,x)).then(function(){x=e(x),J={ret:0,res:x},delete O[x],u.postMessage("webframe","RETURN_RES",J,v)})}catch(e){J={ret:e.toString(),res:""},this.postMessage("webframe","RETURN_RES",J,v)}break;case"RENAME_FILE":var V=n.join(j.projectpath,g.oldPath),Q=n.join(j.projectpath,g.newPath),X=void 0;if(!Q||Q.length<=1)return;var z=r(V);if(l.emit("FILE_CHANGE_FROM_EDITOR"),z.isDirectory()){m.manager.stopWatch();var K="darwin"===process.platform?"mv":"ren",Z="darwin"===process.platform?['"'+V+'"','"'+Q+'"']:['"'+V+'"','"'+Q.match(/\\([^\\]+)\\$/)[1]+'"'],$=[],Y=[],ee=w(K,Z,{shell:!0});ee.on("close",function(e){m.manager.restartWatch(),X=0===e?{ret:0,res:{path:g.newPath,info:t(z)}}:{ret:"目录修改错误",res:""},u.postMessage("webframe","RETURN_RES",X,v)}),ee.stdout.on("data",function(e){$.push(e)}),ee.stderr.on("data",function(e){Y.push(e)})}else{try{o.renameSync(V,Q),delete O[e(g.oldPath)];var te=o.lstatSync(Q);O[g.newPath]=!0,X={ret:0,res:{path:g.newPath,info:t(te)}}}catch(e){X={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",X,v)}break;case"RM_DIR":var re=j.projectpath,se=n.join(re,g.path);l.emit("FILE_CHANGE_FROM_EDITOR"),A=!0,i("**",{cwd:se,nosort:!0,strict:!1,silent:!0,absolute:!0},function(t,r){if(console.log("files",r),t){var s={ret:t?t.toString():0,res:t?"":dirs};return void u.postMessage("webframe","RETURN_RES",s,v)}A=!1,c(se).then(function(){var t={ret:0,res:""};r.forEach(function(t){var r=n.relative(re,t);r=e(r),delete O[r]}),u.postMessage("webframe","RETURN_RES",t,v)}).catch(function(e){var r={ret:t?t.toString():0,res:t?"":dirs};u.postMessage("webframe","RETURN_RES",r,v)})});break;case"ADD_FILE":var ie=n.join(j.projectpath,g.path),oe=o.existsSync(ie),ne=void 0;if(oe)ne={ret:g.path+" already existed"},this.postMessage("webframe","RETURN_RES",ne,v);else{try{l.emit("FILE_CHANGE_FROM_EDITOR"),o.writeFileSync(ie,"","utf8"),O[e(g.path)]=!0;var ae=o.lstatSync(ie);ne={ret:0,res:{path:g.path,info:t(ae)}}}catch(e){ne={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",ne,v)}break;case"ADD_PAGE":var ce=n.join(j.projectpath,g.path),pe=g.name,he={ret:0,res:[]},ue=!1;for(var de in M){var fe=n.join(ce,""+pe+de);if(!o.existsSync(fe)){var Ee=M[de].replace(/{{page}}/g,pe);try{l.emit("FILE_CHANGE_FROM_EDITOR"),o.writeFileSync(fe,Ee,"utf8"),O[e(fe)]=!0;var _e=o.lstatSync(ce);he.res.push({path:e(n.join(g.path,g.name+de)),info:t(_e)})}catch(e){ue=!0,he={ret:e.toString(),res:""}}}}if(!ue){var me=n.join(j.projectpath,"app.json"),le=JSON.parse(o.readFileSync(me,"utf8"));"/"===g.path[0]&&(g.path=g.path.substr(1));var ge=le.pages||[];ge.push(n.join(g.path,g.name).replace(/\\/g,"/")),le.pages=ge;try{o.writeFileSync(me,JSON.stringify(le,null,parseInt(f.getEditorConfig("tabSize"))),"utf8")}catch(e){ue=!0,he={ret:e.toString(),res:""}}}this.postMessage("webframe","RETURN_RES",he,v);break;case"MAKE_DIR":var ve=n.join(j.projectpath,g.path),we=void 0;try{l.emit("FILE_CHANGE_FROM_EDITOR"),o.mkdirSync(ve),O[e(g.path)]=!0;var Re=o.lstatSync(ve);we={ret:0,res:{path:ve,info:t(Re)}}}catch(e){we={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",we,v);break;case"GET_PROJECT_INFO":this.postMessage("webframe","RETURN_RES",{ret:0,res:j},v);break;case"SET_EDIT_WEBVIEW":var Se=g.editWebview;l.setProjectEditWebview(j.hash,Se),this.postMessage("webframe","RETURN_RES",{ret:0,res:Se},v);break;case"FIND_STR":var be=g.options,je=g.str,Ne=be.cwd,Ie=be.i,Te=be.wholeword;Ne=n.join(j.projectpath,Ne),S({str:je,cwd:Ne,i:Ie,wholeword:Te,project:j},function(e,t){var r={};e?r.ret=JSON.stringify(e):(r.ret=0,r.res=t),u.postMessage("webframe","RETURN_RES",r,v)});break;case"SHOW_ITEM_IN_FOLDER":var De=n.join(j.projectpath,g.filePath);nw.Shell.showItemInFolder(De);break;case"FORMAT_CODE":var Me=g.code,Oe=g.options;b(Me,Oe,function(e,t){var r={ret:0,res:t};u.postMessage("webframe","RETURN_RES",r,v)});break;case"REBUILD":E.restartImmediate(g);break;case"SET_CLIPBOARD":nw.Clipboard.get().set({data:g.data,type:"text"});break;case"GET_IMAGE_SIZE":p(n.join(j.projectpath,g.path),function(e,t){if(e){var r={ret:e.toString(),res:""};u.postMessage("webframe","RETURN_RES",r,v)}var s={ret:0,res:{width:t.width,height:t.height}};u.postMessage("webframe","RETURN_RES",s,v)})}},postMessage:function(e,t,r,s){var i=this,o={to:e,msg:r,command:t,ext:s};return this.port?(this.msgQuery.length&&(this.msgQuery.forEach(function(e){i.port.postMessage(e)}),this.msgQuery=[]),void this.port.postMessage(o)):void this.msgQuery.push(o)},initport:function(e){var t=this;"edit"===e.name&&(this.port=e,this.port.onMessage.addListener(this.onMessage),this.port.onDisconnect.addListener(function(){t.port.onMessage.removeListener(t.onMessage),delete t.port,delete t.portID,t.msgQuery=[]}),this.postMessage("contentscript","SHAKE_HANDS",{}))},initRuntime:function(){chrome.runtime.onConnect.addListener(this.initport)},addContentScripts:function(){this.webview.addContentScripts([{name:"contentscript",matches:["<all_urls>"],js:{files:["app/dist/contentscript/editcontent.js"]},run_at:"document_start"}])},ewWindow:function(){this.webview.addEventListener("newwindow",function(e){var t=e.targetUrl;t&&nw.Window.open(t,{width:799,height:799})})},_windowFocus:function(){var e=this;if("focus"!==this.currentStatus){var t={eventType:"focus"};this.postMessage("webframe","WINDOW_CHANGE",t,{}),setTimeout(function(){e.webview.focus()},100),this.currentStatus="focus"}},_windowBlur:function(){if("blur"!==this.currentStatus){var e={eventType:"blur"};this.postMessage("webframe","WINDOW_CHANGE",e,{}),this.currentStatus="blur"}},_editWebview:function(e,t){e.hash===this.props.project.hash&&this.postMessage("webframe","WEBVIEW_SHOW_CHANGE",{editWebview:t},{})},_openProjectFile:function(e){var t=this,r=f.getLastShow();"edit"===r||this.props.optProject("edit",function(){setImmediate(function(){t.webview.focus(),t.postMessage("webframe","OPEN_FILE",e,{})})})},_updateEditorConfig:function(e){this.postMessage("webframe","UPDATE_EDITOR_CONFIG",e)},_saveAllAndRebuild:function(e){this.postMessage("webframe","SAVE_ALL_AND_REBUILD",e)},_transferEditorCommand:function(e){var t=this;setImmediate(function(){t.webview.focus()}),this.postMessage("webframe","EXEC_EDITOR_COMMAND",e)},_removeLeadingSlash:function(e){return"/"===e[0]?e.substr(1):e},componentDidMount:function(){this.msgQuery=[],this.show=this.props.show;var e=this.refs.container,t=this.webview=document.createElement("webview");t.className="simulator-bd-webview_body",t.setAttribute("partition","persist:trusted"),t.setAttribute("tabIndex","-1"),t.setUserAgentOverride(t.getUserAgent()+" devtoolsedit"),e.appendChild(t),this.ewWindow(),this.addContentScripts(),this.initRuntime(),t.addEventListener("dialog",function(e){var t=e.messageType||"",r=e.messageText,s=!1,i=void 0;try{i=JSON.parse(e.messageText),s=!0}catch(e){}var o=e.dialog;if("alert"===t)y(r);else if("confirm"===t)e.preventDefault(),s?C(i.content,i.subcontent,function(e){e?o.ok():o.cancel()}):C(r,function(e){e?o.ok():o.cancel()});else if("prompt"===t){var n=prompt(r);null!==n?o.ok(n):o.cancel()}}),t.addEventListener("blur",function(e){d.editorBlur()}),t.addEventListener("focus",function(e){d.editorFocus()});var r=m.manager;r.on("FILE_CHANGE",this._initWatcher),t.src="app/html/edit.html",f.on("WINDOW_BLUR",this._windowFocus),f.on("WINDOW_FOCUS",this._windowBlur),l.on("PROJECT_STORES_CHANGE_EDIT_WEBVIEW",this._editWebview),f.on("OPEN_PROJECT_FILE",this._openProjectFile),f.on("UPDATE_EDITOR_CONFIG",this._updateEditorConfig),f.on("EXEC_EDITOR_COMMAND",this._transferEditorCommand),l.on("SAVE_ALL_AND_REBUILD",this._saveAllAndRebuild)},componentWillUnmount:function(){chrome.runtime.onConnect.removeListener(this.initport),f.removeListener("WINDOW_BLUR",this._windowFocus),f.removeListener("WINDOW_FOCUS",this._windowBlur),l.removeListener("PROJECT_STORES_CHANGE_EDIT_WEBVIEW",this._editWebview),f.removeListener("OPEN_PROJECT_FILE",this._openProjectFile),f.removeListener("UPDATE_EDITOR_CONFIG",this._updateEditorConfig),f.removeListener("EXEC_EDITOR_COMMAND",this._transferEditorCommand),l.removeListener("SAVE_ALL_AND_REBUILD",this._saveAllAndRebuild);var e=m.manager;e.removeListener("FILE_CHANGE",this._initWatcher),this.webview.remove(),O={}},_initWatcher:function(r,s,i,o){if(r.hash===this.state.project.hash){var a=o?+o.mtime:0,c=o?t(o):{},p={};i=e(i);var h=(n.join(r.projectpath,i),O[i]);if("unlinkDir"===s&&(h=O[i+"/"]),"add"!==s&&"addDir"!==s||h)if("unlink"!==s&&"unlinkDir"!==s||!h){if("change"!==s)return void g.info("edit.js watch "+s);if(O[i]===a)return;O[i]=a,p={eventType:s,fileName:i,info:c}}else p={eventType:s,fileName:i,info:c},delete O[i];else p={eventType:s,fileName:i,info:c};this.postMessage("webframe","FILE_CHANGE",p,{})}},componentWillReceiveProps:function(e){"edit"===e.show?this._windowFocus():this._windowBlur()},render:function(){var e=this.props,t=e.show,r=(e.project,"edit"===t?{}:u.displayNone);return h.createElement("div",{className:"edit",ref:"container",style:r})}});_exports=F}var _exports;init(),module.exports=_exports;