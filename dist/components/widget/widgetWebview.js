"use strict";function init(){var e=require("../../lib/react.js"),t=require("../../stores/webviewStores.js"),i=require("../../stores/windowStores.js"),s=(require("../../actions/leftviewActions.js"),require("../../stores/projectStores.js")),r=require("../../common/log/log.js"),o=require("../../config/config.js"),n=(require("../../utils/newReport.js"),require("../../actions/webviewActions.js")),a=require("../../actions/windowActions.js"),h=(require("querystring"),require("../../weapp/utils/projectManager.js")),c=require("../../config/compileTypeConfig.js"),p=(require("../../common/request/request.js"),require("../../config/urlConfig.js"),require("../../common/actions/actions.js")),d=300,g=require("../../config/webviewIDConfig.js"),u=g.DP_WEBVIEW_ID,w=function(e){a.showWidgetWebviewError(e)},v=e.createClass({displayName:"WebviewBody",getInitialState:function(){this.dpsMsgQueue=[];var e=t.getNetworkType();return{webviewID:u,offset:this.props.offset,networkType:e}},reload:function(){this.webview.reload()},setUserAgentOverride:function(e){e=e||i.getUA(),e=e.replace("{{webviewID}}",this.state.webviewID),this.props.project&&(e=e+" widget weapp/"+this.id),this.webview.setUserAgentOverride(e)},initWidgetPage:function(){var e=this.refs.container,t=this.state.webviewID,i=this.webview=document.createElement("webview");i.className="simulator-bd-webview_body webviewbody"+t,i.setAttribute("partition","persist:trusted"),e.appendChild(i),this.setUserAgentOverride(),this.addContentScripts(i),this.initRuntime(),this.onErrorOccurred(),this.onHeadersReceived();try{i.src="http://"+this.props.project.hash+".widget.open.weixin.qq.com/"+this.getWidgetPageDir()+"/widgetPage.html"}catch(e){}this._setWebviewInfo()},setWebviewSrc:function(e){this.webview.src=e},initEvent:function(){var e=this.webview;global.appConfig.isDev||global.appConfig.isGamma||e.contextMenus.onShow.addListener(function(e){e.preventDefault()})},getWidgetPageDir:function(){var e="";try{for(var t=this.props.project,i=h.getAppConfigJSONSync(t),s=i.widgets||[],r=0;r<s.length;r++){var o=s[r];if("search"==t.compileType&&"search"==o.type){e=o.path;break}if("widget"==t.compileType&&"conversation"==o.type){e=o.path;break}}}catch(t){e=""}return e},onErrorOccurred:function(){var e=this.webview,t=e.request;t.onErrorOccurred.addListener(function(e){var t=e.type;"script"!==t&&"main_frame"!==t&&"net::ERR_ABORTED"!==e.error&&w({group:"渲染层网络错误",type:error,msg:o.WEBVIEW_NETWORK_ERROR})},{urls:["<all_urls>"]})},onHeadersReceived:function(){var e=this,t=this.webview,i=t.request;i.onHeadersReceived.addListener(function(t){var i=t.type;if("image"===i){var s=t.url;if(o.weappLocalIdRegular.test(s)||o.weappWidgetPageRegular.test(s))return{};if("wifi"!=e.state.networkType&&!e.imageSizeControl[s]){var r=0;t.responseHeaders.forEach(function(e){"content-length"==e.name.toLowerCase()&&(r=parseInt(e.value))});var n=e.imageSizeControl.totalSize+r;if(n>1024*d)return w({group:"图片超过大小限制",type:"error",msg:"在非 wifi 环境下，30 分钟内图片大小不能超过 "+d+" kb"}),{cancel:!0};e.imageSizeControl.totalSize+=r,e.imageSizeControl[s]=!0}}return{}},{urls:["<all_urls>"]},["blocking","responseHeaders"])},addContentScripts:function(e){e.addContentScripts([{name:"contentscript",matches:["<all_urls>"],js:{files:["app/dist/contentscript/contentScript.js"]},run_at:"document_start"}])},_initport:function(e){var i=this;e.name==="webview"+this.state.webviewID&&(this.port=e,this.portID=e.name,t.addWebviewPorts(this.portID,this.port),this.port.onMessage.addListener(this.onMessage),this.port.onDisconnect.addListener(function(){t.delWebviewPorts(i.portID),i.port.onMessage.removeListener(i.onMessage),delete i.port,delete i.portID,i.msgQuery=[]}),this.postMessage("contentscript",{},"SHAKE_HANDS"))},initRuntime:function(){chrome.runtime.onConnect.addListener(this._initport)},toAppService:function(e){e.eventName=e.eventName.replace("publish_",""),e.webviewID=this.state.webviewID,n.postMessageToAS(e)},onMessage:function(e){var t=this,s=e.command,o=(this.state.webviewID,e.msg);if(this.props.project){var n=e.weappID;if(n!==this.id){r.error("webviewbody.js get a message from a wrong webview"),chrome.runtime.onConnect.removeListener(this._initport),r.info("webviewbody.js this.componentWillUnmount begin");try{this.componentWillUnmount(),r.info("webviewbody.js this.componentWillUnmount end")}catch(e){this.webview.remove(),r.error("webviewbody.js trigger this.componentWillUnmount() error "+e.toString())}return}}switch(s){case"TO_APP_SERVICE":this.toAppService(o);break;case"WEBVIEW_READY":var a=this.props.project.widgetOptions||{},h=this.props.project.compileType,d=i.getWidgetOffset(h),g=d.width-30,u=d.height-30,v=u/g;if(h==c.search)p.getSearchWidgetInitData(this.props.project,function(e,i){if(e)return void w({group:"网络错误",type:"error",msg:"获取搜索数据失败，请更换搜索条件"});var s="",r="",o=a.currentService&&a.currentService.box_type;try{var n=i.resultlist[0].providerlist[0].providerinfo;s=n.wxaData,r=n.widgetData,v=n.height/n.width,u=g*v}catch(e){s="",r="",g=d.width-30,u=d.height-30}try{i.debug_info&&w({group:"服务器调试信息",type:"info",msg:{"网络状态码":i.debug_info.status_code||"","返回":i.debug_info.resp_data||"","耗时":i.debug_info.cost_time_ms||""}})}catch(e){}t.postMessageToAS({eventName:"onCanvasInsert",data:{query:{query:a.searchQuery,type:o,widgetData:a.widgetData||r,wxaData:s,wxParamData:a.boxQI},width:g,height:Math.ceil(u)}}),t.setWidgetOffset({width:g,height:u}),t.props.project.widgetOptions.wxaData=s,t.setState({offset:{width:g+30,height:u+30}})});else{var m={title:"",path:"",query:{},cacheKey:""},l=a.path||"",f=l.split("?"),_={};try{f=f[1].split("&"),f.forEach(function(e){var t=e.split("=");_[t[0]]=t[1]})}catch(e){_={}}m.title=a.title,m.path=l.split("?")[0],m.query=_,m.cacheKey=a.cacheKey,m.width=d.width,m.height=d.height,this.postMessageToAS({eventName:"onCanvasInsert",data:m})}}},postMessage:function(e,t,i,s){var r=this,o={to:e,msg:t,command:i,ext:s};return o.webviewID=this.state.webviewID,o.id=this.id,this.port?(this.msgQuery.length&&(this.msgQuery.forEach(function(e){r.port.postMessage(e)}),this.msgQuery=[]),void this.port.postMessage(o)):void this.msgQuery.push(o)},_onCompileChange:function(e){"widget"===e&&this._didMount()},_didMount:function(){this.mounted||(this.mounted=!0,this.initWidgetPage(),this.initEvent())},_restart:function(e){e.compileType!=c.widget&&e.compileType!=c.search||this.webview&&this.webview.reload()},_onWidgetDrawCanvas:function(e){this.postMessage("webframe",{data:e},"WIDGET_DRAW_CANVAS")},_onDPServcieReady:function(){var e=this;this.dpsMsgQueue.length&&(this.dpsMsgQueue.forEach(function(t){e.postMessageToAS(t)}),this.dpsMsgQueue=[])},_setWebviewInfo:function(e){var t=this;setTimeout(function(){var e=t.props.project.compileType,s=i.getWidgetOffset(e);t.setWidgetOffset({width:s.width-30,height:s.height-30})},0)},setWidgetOffset:function(e){var t="",s=e.width,r=e.height,o=this.props.project.compileType;o==c.search?(t="height:"+Math.ceil(r)+"px;width:"+s+"px;padding:12px 15px 18px 15px;",i.setSearchWidgetRadio(r/s)):o==c.widget&&(t="height:100%;width:100%"),this.postMessage("webframe",{data:{width:s,height:Math.ceil(r),style:t}},"WIDGET_SET_CANVAS")},postMessageToAS:function(e){return t.getAppServiceReadyState()?n.postMessageToAS(e):void this.dpsMsgQueue.push(e)},_onNetworkChange:function(e){this.setState({networkType:e})},resetImageSizeControl:function(){this.imageSizeControl={totalSize:0,timestamp:Date.now()}},componentDidMount:function(){this.id=parseInt(1e5*Math.random()),this.msgQuery=[],s.on("ON_COMPILE_CHANGE",this._onCompileChange),s.on("RESTART_PROJECT",this._restart),t.on("WIDGET_DRAW_CANVAS",this._onWidgetDrawCanvas),t.on("APPSERVICE_INIT",this._onDPServcieReady),i.on("SET_WEBVIEW_INFO",this._setWebviewInfo),t.on("SIMULATOR_NETWORK_CHANGE",this._onNetworkChange),this.resetImageSizeControl(),this.timer=setInterval(this.resetImageSizeControl,18e5),this._didMount()},componentWillUnmount:function(){s.removeListener("ON_COMPILE_CHANGE",this._onCompileChange),s.removeListener("RESTART_PROJECT",this._restart),t.removeListener("WIDGET_DRAW_CANVAS",this._onWidgetDrawCanvas),t.removeListener("APPSERVICE_INIT",this._onDPServcieReady),t.removeListener("SIMULATOR_NETWORK_CHANGE",this._onNetworkChange),i.removeListener("SET_WEBVIEW_INFO",this._setWebviewInfo),chrome.runtime.onConnect.removeListener(this._initport),this.webview&&this.webview.remove(),clearInterval(this.timer)},render:function(){var t=this.state.offset;return e.createElement("div",{className:"simulator-bd-webview",style:{height:Math.ceil(t.height),width:t.width},ref:"container"})}});_exports=v}var _exports;init(),module.exports=_exports;